#!/usr/bin/env ruby
# Check output of test_vga1.vvp

# First parse the file where output was captured
data = ARGF.read

hsync = []
vsync = []
pixel = []

data.lines.each do |line|
  if match = /^(\d),(\d),(\d)/.match(line)
    hsync << match[1].to_i
    vsync << match[2].to_i
    pixel << match[3].to_i
  end
end

=begin
# To visualize VGA output
pixel.each_slice(800) do |pixels|
  puts pixels.join
end
=end

def fail(msg)
  $stderr.puts msg
  Kernel.exit 1
end

class Numeric
  def one?
    self == 1
  end
end

# We start recording the outputs of the VGA controller, once per VGA clock tick,
# as soon as vsync goes high
# It should remain high for the rest of the screen, until it reaches the last 2
# (invisible) rows at the bottom
unless vsync[0...-1600].all?(&:one?) && vsync[-1600..-1].all?(&:zero?)
  fail "vsync bad"
end

# hsync should be high for 656 clocks, low for 96 clocks, high for 48 clocks, then repeat
hsync.each_slice(800) do |h|
  unless h[0...656].all?(&:one?) && h[656...752].all?(&:zero?) && h[752...800].all?(&:one?)
    fail "hsync bad"
  end
end

lines = pixel.each_slice(800).to_a

# We should have 33 empty lines at the top
# This is called the "back porch" in VGA terminology
lines[0...33].each do |line|
  fail "bad back porch" unless line.all?(&:zero?)
end

# Then 480 visible lines, divided into rows of 16 lines each
expect = [
  "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00010000001001000010010000010000000000000011100000010000000011000000000000000000000000000000000000000000000000000000001000111000000010000111100001111000000010000011110000011100011111100011110000111000000000000000000000000000000000000000000001110000001111000001100001111000000111000111100001111100011111100001110001000010011111000011110001000100010000000100001001000110001110000111100000111000011110000011110011111110010001001000001011000010010000101100001001111110001111000100000001111100000110000000000000100000000000000100000000000000000001000000000000011110000000000100000000010000000001000100000001110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00010000001001000010010000010000000000000100100000010000000110000011000000000000000000000000000000000000000000000000011001100100000110000000010000000100000110000010000000100000010000100110010001000100000000000000000000000000000000000000000000001100010001100010100001000100001000000100110001000000010000000010000001000010000100000000010001001100010000000100011001100110011001000100010001100100010001000110000000010000010001001100001011000010010001000100001000000110001000000100000000001100001011000000000000111000000000000100000000000000000001000000000000010000000000000100000000000000000000000100000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00010000001001000010010000111100011000000100100000010000001000000000100000000000000000000000000000000000000000000000010001000100011110000000010000000100000100000010000001000000010001000100010001000100000000000000000000000000000000000000000000000100010000100010110001000100010000000100010001000000010000000100000001000010000100000000010001001000010000000110011001100110010001000100001001000100010001000100000000010000010001000100001011000010011001000100010000000100001000000110000000001100010001100000000000000000000000000100000000000000000001000000000000010000000000000100000000000000000000000100000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00010000001001000111111001000000011001100110100000010000001000000000110000010000000100000000000000000000000000000000110001001110000010000000010000000100001100000010000001000000000001000110010001000100000110000001100000000110000000000100000000000100010011100010010001000100010000000100001001000000010000000100000001000010000100000000010001010000010000000110101001110110010001000100001001000100010001000110000000010000010001000100011011000010001001000010010000001100001000000010000000001100100000100000000000000000001110000111100000111100001111000011100001111100001111100111110000110000011111000100010000010000011111000111110000111000011110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00010000001001000010010001000000000011000011000000010000010000000000010000010000000100000000000000000000000000000000100001011010000010000000010000111000001001000011100001111000000011000011100001000110000110000001100000011100000000000011000000111100010011100110010001111000010000000100001001111100010000000100111001111110000100000000010001100000010000000101101001010110010001000100010001000100010001000011100000010000010001000100010001010010001010000010100000011000001000000011000000001100000000000000000000000000000001000100010000100000001001000010010000010000010001000100010000010000000001000100100000010000010100100100010001100100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00010000000000000010010001110000000010000111000000000000010000000000010001110110000100000000000000000000000000000001100001010010000010000000100000000100001001000000010001000100000010000010110000111100000000000000000001110000011111100000110000100000010011100100010001000100010000000100001001000000011111000100011001000110000100000000010001010000010000000101001001011110010001000111100001000100011111000000110000010000010001000110010001011010000110000001100000110000001000000001000000001100000000000000000000000000000001000100010001000000010001000100010000010000010001000100010000010000000001000101000000010000010100100100010001000100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00010000000000000111111000001100000100000100110000000000010000000000010000111000011111100000000001111110000000000001000001100010000010000011000000000100010001000000010001000100000110000100011000000100000000000000000001000000000000000000011000100000010011100111111001000010010000000100001001000000010000000100011001000110000100000000010001011000010000001100001001001110010001000100000001000100010011000000011000010000010001000010010001101010001010000001000000100000001000000001100000001100000000000000000000000000001111000100010001000000010001000111110000010000001111000100010000010000000001000111000000010000010100100100010001000100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00000000000000000010010000000010001000000100010000000000010000000000010000101000000100000000000000000000000000000011000001000100000010000010000000000100011111100000010001000100000100000100001000000100000000000000000001110000000000000000110000000000010011100100001001000010010000000100010001000000010000000100011001000110000100000000010001001000010000001100001001001110010001000100000001000100010001000000001000010000010001000010110001100110001001000001000001000000001000000000100000001100000000000000000000000000010001000100010001000000010001000100000000010000010000000100010000010000000001000101100000010000010100100100010001000100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00000000000000000010010000000110010001100100110000000000011000000000010001100100000100000001100000000000000110000010000001100100000010000100000000000100000011000000010001100100000100000100011000001100000110000001100000011100011111100011000000000000010000001100001001000100001000000100110001000000010000000010011001000110000100000000110001000100010000001100001001000110011001000100000001100100010001100000010000010000011001000010100001000110010001000001000001000000001000000000110000001100000000000000000000000000010001000100010000100000001001000010000000010000010000000100010000010000000001000100110000010000010100100100010001100100010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00010000000000000010010001111100000001100011101000000000001000000000010000000000000100000001100000000000000110000110000000111000011111000111111001111000000011000111100000111000000100000011110000111000000110000001100000000110000000000100000000100000010000001000001001111000000111000111100001111110010000000001110001000110011111000111100001000110011111101100001001000110001110000100000000111000010000100111100000010000001110000001100001000110010000100001000001111110001000000000010000001100000000000000000000000000001111000111100000111100001111000011110000010000001111100100010001111100000001000100010000011100010100100100010000111000011110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00000000000000000000000000010000000000000000000000000000001100000000100000000000000000000000100000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000001000000000011000001100000000000111111000000000000000000000000000000000000000000000000000000000010000100000000000000000000001000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00000000000000000000000000010000000000000000000000000000000111000001100000000000000000000001000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000001111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011000000000000000000000000000000000000000000000000000000000000000000000000000001000000000001000001100000000000000000000000000000000000000000000000000000000000000000000000000010000100000000000000000011110000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00000000000000000000000000000000000000000000000000000000000001000110000000000000000000000111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001110000000000000000000000000000000000000000000000000000000000000000000000000001111000000000001111100000000000000000000000000000000000000000000000000000000000000000000000000011111000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"
]

lines[33...513].each_slice(16) do |row|
  row.zip(expect) do |actual,expected|
    fail "bad pixel output" unless actual.join == expected
  end
end

# Then 12 more empty lines
lines[513...525].each do |line|
  fail "bad front porch" unless line.all?(&:zero?)
end
